import os
import discord
from discord import app_commands
from discord.ext import tasks, commands
import aiohttp
import pymongo
from datetime import datetime

# Environment variables
DISCORD_TOKEN = os.getenv('DISCORD_TOKEN')
MONGO_URI = os.getenv('MONGO_URI')
APIFY_TOKEN = os.getenv('APIFY_TOKEN')
ACTOR_ID = 'your_username~mlbb-player-scraper'  # Replace with your Actor ID
GUILD_ID = 123456789012345678  # Your guild ID

# Role mapping
ROLE_MAP = {
    "Warrior": 1452232717339983914,
    "Elite": 1452232985712787497,
    "Master": 1452233028209348660,
    "Grandmaster": 1452233083431555115,
    "Epic": 1452233113609441310,
    "Legend": 1452233142986342420,
    "Mythic": 1452233677839794228,
    "Mythical Glory": 1452233176570269719
}

RANK_ROLE_IDS = list(ROLE_MAP.values())

# MongoDB
client = pymongo.MongoClient(MONGO_URI)
db = client["mlbb_bot"]
users = db["users"]

intents = discord.Intents.default()
intents.members = True
bot = commands.Bot(command_prefix="!", intents=intents)

async def parse_rank(player_data):
    rank_str = player_data.get('current_rank', '').lower()
    stars = player_data.get('mythic_stars', 0)

    if 'warrior' in rank_str:
        return "Warrior"
    elif 'elite' in rank_str:
        return "Elite"
    elif 'master' in rank_str:
        return "Master"
    elif 'grandmaster' in rank_str:
        return "Grandmaster"
    elif 'epic' in rank_str:
        return "Epic"
    elif 'legend' in rank_str:
        return "Legend"
    elif 'mythic' in rank_str:
        if stars >= 50:
            return "Mythical Glory"  # Glory (50+), Immortal (100+)
        return "Mythic"  # Base (0-24), Honor (25-49)
    return None

async def fetch_mlbb_rank(mlbb_id: str, server_id: str):
    url = f"https://api.apify.com/v2/acts/{ACTOR_ID}/run-sync-get-dataset-items?token={APIFY_TOKEN}"
    payload = {"mlbb_id": mlbb_id, "server_id": server_id}
    
    async with aiohttp.ClientSession() as session:
        async with session.post(url, json=payload) as resp:
            if resp.status != 200:
                return None
            data = await resp.json()
            if not data or 'error' in data[0]:
                return None
            return data[0]  # The result JSON

@bot.event
async def on_ready():
    print(f"Logged in as {bot.user}")
    update_ranks.start()

@bot.tree.command(name="verify", description="Verify your MLBB account and get rank role")
@app_commands.describe(mlbb_id="Your MLBB User ID", server_id="Your MLBB Server ID")
async def verify(interaction: discord.Interaction, mlbb_id: str, server_id: str):
    user_id = interaction.user.id
    guild = interaction.guild
    
    player_data = await fetch_mlbb_rank(mlbb_id, server_id)
    if not player_data:
        await interaction.response.send_message("Failed to fetch rank. Check IDs or Actor status.", ephemeral=True)
        return
    
    rank = await parse_rank(player_data)
    if not rank:
        await interaction.response.send_message("Unknown rank fetched.", ephemeral=True)
        return
    
    # Store in DB
    users.update_one(
        {"discord_id": user_id},
        {"$set": {
            "mlbb_id": mlbb_id,
            "server_id": server_id,
            "current_rank": rank,
            "player_data": player_data,  # Cache full data
            "verification_date": datetime.utcnow()
        }},
        upsert=True
    )
    
    member = guild.get_member(user_id)
    # Remove old roles
    roles_to_remove = [guild.get_role(rid) for rid in RANK_ROLE_IDS if guild.get_role(rid) in member.roles]
    if roles_to_remove:
        await member.remove_roles(*roles_to_remove)
    
    # Add new role
    role_id = ROLE_MAP.get(rank)
    if role_id:
        role = guild.get_role(role_id)
        if role:
            await member.add_roles(role)
    
    await interaction.response.send_message(f"Verified! Your rank is {rank}. Role assigned.", ephemeral=True)

@tasks.loop(hours=1)  # Every hour; adjust to 24 for daily
async def update_ranks():
    guild = bot.get_guild(GUILD_ID)
    if not guild:
        return
    
    for user_data in users.find():
        discord_id = user_data.get("discord_id")
        mlbb_id = user_data.get("mlbb_id")
        server_id = user_data.get("server_id")
        old_rank = user_data.get("current_rank")
        
        if not (mlbb_id and server_id):
            continue
        
        player_data = await fetch_mlbb_rank(mlbb_id, server_id)
        if not player_data:
            continue  # Skip if fetch fails
        
        new_rank = await parse_rank(player_data)
        if not new_rank or new_rank == old_rank:
            continue
        
        member = guild.get_member(discord_id)
        if not member:
            continue
        
        # Update roles
        roles_to_remove = [guild.get_role(rid) for rid in RANK_ROLE_IDS if guild.get_role(rid) in member.roles]
        if roles_to_remove:
            await member.remove_roles(*roles_to_remove)
        
        role_id = ROLE_MAP.get(new_rank)
        if role_id:
            role = guild.get_role(role_id)
            if role:
                await member.add_roles(role)
        
        # Update DB
        users.update_one({"discord_id": discord_id}, {"$set": {"current_rank": new_rank, "player_data": player_data}})
        
        # Notify
        await member.send(f"Your MLBB rank changed from {old_rank} to {new_rank}! Role updated.")

@update_ranks.before_loop
async def before_update_ranks():
    await bot.wait_until_ready()

bot.run(DISCORD_TOKEN)